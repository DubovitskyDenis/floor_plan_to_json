# Floor Plan to JSON Parser

Прототип для извлечения архитектурной геометрии (стены) из изображений планов этажей и конвертации в JSON формат, пригодный для 2D/3D визуализации.

## Цель проекта

Показать подход к автоматическому извлечению геометрии стен из растровых изображений планов и преобразованию в структурированный JSON формат.

## Технологический стек

### Выбранный подход: **Гибридный (OpenCV + классическая CV)**

**Почему этот стек?**

1. **OpenCV** - основной инструмент:
   - Отлично подходит для детекции линий в архитектурных чертежах
   - Не требует обучения моделей (быстрый старт)
   - Эффективен для обработки технических чертежей с четкими границами
   - Легко интегрируется с другими инструментами

2. **Hough Transform (Probabilistic)**:
   - Классический метод для детекции прямых линий
   - Хорошо работает на бинаризованных изображениях
   - Быстрый и надежный для архитектурных планов

3. **LSD (Line Segment Detector)** - альтернативный метод:
   - Более точный для тонких линий
   - Лучше справляется с размытыми границами
   - Медленнее, но качественнее

## Этапы пайплайна

### 1. Предобработка изображения
- Конвертация в grayscale
- Бинаризация (Otsu thresholding)
- Автоматическая инверсия (если фон светлый)
- Морфологические операции (закрытие/открытие) для очистки шума

### 2. Детекция линий
- **Вариант A**: Probabilistic Hough Transform (`HoughLinesP`)
  - Быстрый и эффективный для четких линий
- **Вариант B**: Line Segment Detector (LSD)
  - Более точный, но медленнее

### 3. Постобработка
- Фильтрация по минимальной длине
- Объединение близких и коллинеарных линий
- Удаление дубликатов

### 4. Экспорт в JSON
- Структурированный формат с метаданными
- Координаты в пикселях (можно масштабировать позже)

## Установка

```bash
pip install -r requirements.txt
```

## Использование

### Базовое использование

```bash
python floor_plan_parser.py --input plan1.png plan2.jpg plan3.png
```

### С дополнительными опциями

```bash
# Использовать LSD детектор (медленнее, но точнее)
python floor_plan_parser.py --input plan1.png --lsd

# Изменить минимальную длину линии
python floor_plan_parser.py --input plan1.png --min-length 30

# Указать выходной файл
python floor_plan_parser.py --input plan1.png --output results.json
```

##  Формат выходного JSON

```json
[
  {
    "meta": {
      "source": "test_01.png"
    },
    "walls": [
      {
        "id": "w1",
        "points": [[100, 200], [300, 200]]
      },
      {
        "id": "w2",
        "points": [[300, 200], [300, 400], [100, 400]]
      }
    ]
  }
]
```


## Слабые места текущей реализации

1. **Перспектива**: Не обрабатывает фотографии с перспективными искажениями
2. **Сложная геометрия**: Может пропускать криволинейные стены (часто двери обозначаются кривыми линиями)
3. **Пересечения**: Не всегда корректно обрабатывает пересечения стен
4. **Шум**: На "грязных" фотографиях может находить ложные линии
5. **Толщина стен**: Не различает толщину стен (все линии одинаковые)

### Как можно решить задачу OCR 
1. **Детекция текста**: С помощью paddle text detection моделей выделять полигоны текста.
2. **Распознование текста**: Задетектировонные полигоны текста подавать на вход модели распознвания текста (найти подходящую модель в opensource или дотюнить одну из opensource моделей).



### Как можно лучше решить задачу эту задачу:
1. **Автоматическое определение ориентации изображения**: обучить классификационную модель для определения угла поворота изображения.
2. **Улучшение локализации стен**: Использовать yolov8 сегментационные модели для сегментации стен. По моему опыту с задачей сегментаиции лучше всего справлялись yolo модели.
2. **Нахождение стен/окон**: Разметить некоторый набор фотографий для задачи детекции окон/дверей (как разные классы).
3. **Постобработка результатов**: для найденных боксов окон/дверей локализовать с помощью дополнительной обработки результатов в для отдельных локализованных боксов целевых объектов, выделить более точно границы стен так же с помощью алгоритмов из opencv.
4. **Валидация**: Проверка геометрической корректности (замкнутость, пересечения)


## Визуализация результатов

Для визуализации найденных стен и отверстий на исходных изображениях используйте скрипт `visualize_results.py`:

```bash
# Базовое использование
python visualize_results.py --json output.json --images-dir . --output-dir visualized

# Без отображения отверстий
python visualize_results.py --json output.json --no-openings

# Без меток ID
python visualize_results.py --json output.json --no-labels

# Настройка цвета и толщины стен
python visualize_results.py --json output.json --wall-color 255 0 0 --wall-thickness 3
```

Скрипт создаст визуализации с:
- Зелеными линиями для стен
- Легендой в углу изображения

## Примеры использования

См. папку `examples/` для примеров входных изображений и результатов.


s

В качестве источника изображений выбран CubiCasa5K, так как он содержит реальные планы квартир с аннотациями стен, дверей и помещений, что напрямую соответствует задаче извлечения архитектурной геометрии. Датасет широко используется в академических и индустриальных работах, что снижает риски переобучения на синтетике. В нем так же имеется разметка формата COCO.